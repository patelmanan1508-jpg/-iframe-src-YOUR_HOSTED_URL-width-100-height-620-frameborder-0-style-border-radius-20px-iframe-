<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XBB System â€” FAQ Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f5f3ef;
    --surface: #ffffff;
    --border: #e2ddd6;
    --accent: #e85d04;
    --accent-dark: #c44c00;
    --accent-light: #fff0e8;
    --text: #1a1614;
    --muted: #7a7067;
    --bot-bg: #f9f7f4;
    --user-bg: #e85d04;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 20px;
    background-image: radial-gradient(circle at 80% 20%, rgba(232,93,4,0.07) 0%, transparent 50%),
                      radial-gradient(circle at 10% 80%, rgba(232,93,4,0.04) 0%, transparent 40%);
  }

  .wrapper { width: 100%; max-width: 700px; }

  .header {
    display: flex; align-items: center; gap: 16px;
    margin-bottom: 24px;
    animation: fadeDown 0.5s ease both;
  }

  .logo-mark {
    width: 48px; height: 48px; background: var(--accent);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px; color: white;
    flex-shrink: 0; box-shadow: 0 4px 14px rgba(232,93,4,0.3);
  }

  .header-text h1 { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 700; color: var(--text); }
  .header-text p { font-size: 13px; color: var(--muted); margin-top: 2px; font-weight: 300; }

  .status-dot {
    width: 7px; height: 7px; background: #22c55e; border-radius: 50%;
    display: inline-block; margin-right: 5px; animation: pulse 2s infinite;
  }

  .chat-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; overflow: hidden;
    box-shadow: 0 8px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
    animation: fadeUp 0.6s ease both 0.1s;
  }

  .messages {
    height: 460px; overflow-y: auto;
    padding: 24px 22px;
    display: flex; flex-direction: column; gap: 14px;
    scroll-behavior: smooth;
  }

  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .message { display: flex; gap: 10px; animation: msgIn 0.3s ease both; }
  .message.user { flex-direction: row-reverse; }

  .avatar {
    width: 32px; height: 32px; border-radius: 10px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; font-family: 'Syne', sans-serif;
  }

  .bot-avatar { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(232,93,4,0.25); }
  .user-avatar { background: #e8e3db; color: var(--muted); }

  .bubble {
    max-width: 80%; padding: 12px 16px; border-radius: 14px;
    font-size: 14px; line-height: 1.7;
  }

  .bot .bubble {
    background: var(--bot-bg); border: 1px solid var(--border);
    border-top-left-radius: 4px; color: var(--text);
  }

  .user .bubble { background: var(--user-bg); border-top-right-radius: 4px; color: white; }

  .bubble a { color: var(--accent); text-decoration: underline; }
  .user .bubble a { color: #ffe0cc; }

  .dots { display: flex; gap: 4px; align-items: center; padding: 4px 2px; }
  .dots span {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); animation: bounce 1.2s infinite;
  }
  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }

  .suggestions {
    padding: 4px 22px 18px;
    display: flex; flex-wrap: wrap; gap: 7px;
  }

  .suggestion-label {
    font-size: 11px; font-weight: 500; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.08em;
    width: 100%; margin-bottom: 2px;
  }

  .suggestion-btn {
    background: var(--accent-light); border: 1px solid rgba(232,93,4,0.2);
    color: var(--accent-dark); font-family: 'Inter', sans-serif;
    font-size: 12.5px; padding: 6px 13px; border-radius: 20px;
    cursor: pointer; transition: all 0.2s ease;
  }

  .suggestion-btn:hover {
    background: var(--accent); color: white; border-color: var(--accent);
    transform: translateY(-1px); box-shadow: 0 3px 10px rgba(232,93,4,0.25);
  }

  .input-area {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 18px; border-top: 1px solid var(--border); background: #fafaf8;
  }

  .input-area input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px; outline: none;
    color: var(--text); font-family: 'Inter', sans-serif; font-size: 14px;
    transition: border-color 0.2s;
  }

  .input-area input:focus {
    border-color: var(--accent); box-shadow: 0 0 0 3px rgba(232,93,4,0.1);
  }

  .input-area input::placeholder { color: #bbb; }

  .send-btn {
    width: 40px; height: 40px; border-radius: 10px;
    background: var(--accent); border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(232,93,4,0.3);
  }

  .send-btn:hover { background: var(--accent-dark); transform: translateY(-1px); }
  .send-btn svg { width: 16px; height: 16px; fill: white; }

  .footer {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 16px; animation: fadeUp 0.6s ease both 0.2s;
  }

  .footer-left { font-size: 12px; color: var(--muted); }
  .footer-left a { color: var(--accent); text-decoration: none; font-weight: 500; }
  .footer-right { font-size: 12px; color: #bbb; }

  .car-search-box { margin-top: 10px; }
  .car-search-box input {
    width: 100%; padding: 9px 13px;
    border: 1px solid var(--border); border-radius: 8px;
    font-family: 'Inter', sans-serif; font-size: 13px;
    outline: none; background: white; color: var(--text);
    transition: border-color 0.2s;
  }
  .car-search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(232,93,4,0.1); }
  .car-results { margin-top: 8px; max-height: 180px; overflow-y: auto; }
  .car-results::-webkit-scrollbar { width: 3px; }
  .car-results::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .car-result-item {
    padding: 6px 10px; font-size: 13px; border-radius: 6px;
    border-bottom: 1px solid #f0ede8; color: var(--text); line-height: 1.4;
  }
  .car-result-item:last-child { border-bottom: none; }
  .car-result-item.match { background: var(--accent-light); color: var(--accent-dark); font-weight: 500; }
  .car-no-result { font-size: 13px; color: var(--muted); padding: 6px 2px; }
  .car-loading { font-size: 13px; color: var(--muted); padding: 6px 2px; }

  @keyframes fadeDown { from { opacity:0; transform:translateY(-14px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }
  @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  @keyframes bounce { 0%,60%,100% { transform:translateY(0); } 30% { transform:translateY(-5px); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div class="logo-mark">XBB</div>
    <div class="header-text">
      <h1>XBB System Support</h1>
      <p><span class="status-dot"></span>FAQ Assistant Â· Always available Â· No login needed</p>
    </div>
  </div>

  <div class="chat-box">
    <div class="messages" id="messages"></div>

    <div class="suggestions" id="suggestions">
      <div class="suggestion-label">Popular questions</div>
      <button class="suggestion-btn" onclick="ask(this)">Is my car compatible?</button>
      <button class="suggestion-btn" onclick="ask(this)">Battery drain issue</button>
      <button class="suggestion-btn" onclick="ask(this)">PowerUnit not found in app</button>
      <button class="suggestion-btn" onclick="ask(this)">LED bar turns off after 10 seconds</button>
      <button class="suggestion-btn" onclick="ask(this)">How to update firmware?</button>
      <button class="suggestion-btn" onclick="ask(this)">Tesla setup</button>
      <button class="suggestion-btn" onclick="ask(this)">Mercedes MRA2 setup</button>
      <button class="suggestion-btn" onclick="ask(this)">XBB Dongle not found in app</button>
    </div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type your question about XBB..." onkeydown="if(event.key==='Enter') sendMessage()" />
      <button class="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <div class="footer">
    <div class="footer-left">Content from <a href="https://www.xbb.se/en/faq/" target="_blank">xbb.se/faq</a></div>
    <div class="footer-right">Â© Innoware Development AB</div>
  </div>
</div>

<script>
// â”€â”€ FAQ KNOWLEDGE BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FAQ = [
  {
    keywords: ['compatible', 'work with my car', 'my car', 'car model', 'which car', 'what car', 'support my', 'recipe list', 'does it work', 'supported cars', 'list of cars'],
    answer: `__CAR_SEARCH__`
  },
  {
    keywords: ['recipe', 'create recipe', 'new recipe', 'make recipe', 'book appointment', 'sala'],
    answer: `XBB continuously adds new recipes, starting with the most popular cars.\n\nTo create a recipe for your specific car:\nâ€¢ XBB needs physical access to your exact car (with your specific headlight type, gearbox, etc.)\nâ€¢ It takes about 2 hours to extract the needed data\nâ€¢ You can book an appointment in Sala via the "Compatible Cars" menu at xbb.se\n\nğŸ”— <a href="https://www.xbb.se/en/compatible-cars/" target="_blank">Book appointment â†’</a>`
  },
  {
    keywords: ['battery drain', 'drain', 'draining battery', 'battery', 'bms', 'system_active', 'discharge', 'battery flat'],
    answer: `Battery drain is usually caused by one of these:\n\n1. Wrong recipe â€” After locking the car, open the app: SYSTEM_ACTIVE must turn RED within 2 minutes. If it stays green, the recipe isn't compatible â†’ try a different recipe.\n\n2. BMS sensor issue â€” If your car has a BMS current sensor on the battery and you connected directly to the battery terminals, the car can't detect the extra load and won't charge the battery correctly.\n\nFix: Connect AFTER the BMS sensor:\nâ€¢ Positive (+) â†’ car fuse box\nâ€¢ Negative (âˆ’) â†’ chassis ground point\n\nğŸ”— <a href="https://www.xbb.se/en/snabbguide/" target="_blank">Installation manual â†’</a>`
  },
  {
    keywords: ['powerunit not found', 'powerunit missing', 'cant find powerunit', "can't find powerunit", 'power unit not', 'powerunit disappeared', 'no powerunit', 'powerunit gone'],
    answer: `XBB PowerUnit not showing in the app? Check these:\n\n1. Wrong wiring â€” The negative (âˆ’) cable MUST go to pin 6 (GND). Hold the PowerUnit with the logo facing you â€” the LEFT pin is GND.\nğŸ¬ <a href="https://www.youtube.com/watch?v=gKkLxMVfEEk" target="_blank">Watch fix video â†’</a>\n\n2. After firmware update â€” Updating the XBB Dongle resets all settings. You must re-add the PowerUnit and re-select the recipe in the app.\n\n3. Manual PowerUnit firmware update â€” Unplug the Dongle first, then: Main Menu â†’ Update Firmware â†’ select your PowerUnit.\n\n4. Water damage â€” If the PowerUnit wasn't mounted upright, it may have become water damaged and needs replacing.\n\n5. Missed setup step â€” Did you actually add the PowerUnit in the app during installation?`
  },
  {
    keywords: ['led bar turns off', 'lights turn off', 'turns off after', '10 seconds', 'overload', 'blocked output', 'too much current', '15 amp', '15a', 'output blocked'],
    answer: `Your LED bar turning off after ~10 seconds means the output is OVERLOADED.\n\nXBB PowerUnit limits:\nâ€¢ Output 1 (Pin 8) = max 15 Amps\nâ€¢ Output 2 (Pin 5) = max 5 Amps\n\nHow to check: Watts Ã· Voltage = Amps\nExample: 250W Ã· 12.7V = 19.7A â†’ exceeds the 15A limit!\n\nSolution: Use an external relay. The PowerUnit activates the relay, the relay powers your lights directly from the battery.\n\nğŸ”— <a href="https://www.xbb.se/en/kopplingsexempel/" target="_blank">Wiring guide with relay â†’</a>`
  },
  {
    keywords: ['dongle not found', 'cant find dongle', "can't find dongle", 'dongle missing', 'dongle not visible', 'dongle disappeared', 'dongle not showing'],
    answer: `XBB Dongle not showing in the app?\n\nâ€¢ If 10+ minutes passed since closing the app, the Dongle goes into standby. Unplug it from the OBD2 port and plug it back in.\n\nâ€¢ To keep it always visible: tap â˜° Main Menu (top-left) â†’ "Pair with phone"\n\nâ€¢ Make sure Location is enabled on your phone â€” Android requires it for Bluetooth.\n\nâ€¢ Try toggling Bluetooth off and on.`
  },
  {
    keywords: ['firmware', 'update firmware', 'software update', 'how to update', 'new firmware'],
    answer: `How to update firmware:\n\nXBB Dongle:\nâ†’ â˜° Main Menu (top-left) â†’ "Update Firmware" â†’ the app checks and offers an update\n\nXBB PowerUnit:\nâ†’ First UNPLUG the XBB Dongle from the OBD2 port\nâ†’ â˜° Main Menu â†’ "Update Firmware" â†’ select your PowerUnit\n\nâš ï¸ After updating the Dongle, ALL settings are reset. You must:\n1. Re-select your car's recipe\n2. Re-add the XBB PowerUnit in the app`
  },
  {
    keywords: ['tesla', 'model 3', 'model y', 'model s', 'model x', 'tesla dongle', 'tesla cable', 'splitter cable', 'blue connector'],
    answer: `Tesla setup guide:\n\nModel 3 / Y (built early 2023 or before):\nâ†’ Connect under the rear seat ventilation unit (between front seats). Remove the plastic cover, find the blue connector, use a splitter cable between the two connectors.\n\nModel 3 / Y (Q3 2023 or later):\nâ†’ Blue connector is on the right side of the center console next to the driver's leg. Remove the felt mat. Use a splitter cable.\n\nModel S / X (2012â€“2021):\nâ†’ Requires the special Tesla Dongle (RED package, not standard blue)\n\nâš ï¸ Tesla's OBD2 port does NOT provide the needed CAN-bus data â€” a special connection is always required for Model 3/Y.\n\nXBB does NOT sell the Tesla splitter cable. Find it on Tesla forums or specialist resellers.`
  },
  {
    keywords: ['mercedes', 'mra2', 'w214', 'w206', 'x254', 'glc', 'e-class', 'c-class', 'can-fd', 'pp-can', 'adapter cable'],
    answer: `Mercedes MRA2 platform (E/C/GLC 2021 onwards â€” W214, W206, X254):\n\nThese models no longer use CAN-bus through the OBD2 diagnostic port. You must connect to the car's internal CAN-bus network.\n\nOptions:\n1. XBB Dongle + Adapter Cable\n2. PP-CAN-FD product\n\nRequirements:\nâ€¢ XBB Dongle hardware version 2 (sold since June 2024)\nâ€¢ Check in app: Settings â†’ About XBB Dongle â†’ must say "XBB-Dongle-2"\nâ€¢ Technical knowledge of automotive electronics required\n\nğŸ”— <a href="https://www.xbb.se/en/pp-can-fd/" target="_blank">PP-CAN-FD product â†’</a>`
  },
  {
    keywords: ['restart', 'standby', 'wake up', 'accelerometer', 'gyro', 'memory loss', 'wont start', "won't start", 'reload recipe', 'reload every time', 'have to restart'],
    answer: `Your XBB Dongle going into standby is completely normal â€” it protects your car battery.\n\nInside the Dongle is an accelerometer. Sometimes gentle movements (door closing, engine start) aren't enough to wake it.\n\nFix:\nâ€¢ Simply drive the car â€” vibrations will wake it automatically\nâ€¢ Or gently tap the XBB Dongle with your hand\n\nThis is NOT a fault.`
  },
  {
    keywords: ['delay', 'slow', 'lag', 'takes time', 'not instant', 'late'],
    answer: `A small delay when activating lights is normal and NOT caused by Bluetooth.\n\nReal causes:\nâ€¢ Car headlight activation (e.g. Volvo "enhanced high beams" add ~100ms delay)\nâ€¢ Some LED bars have a built-in startup delay of 100â€“150ms\nâ€¢ CAN data reading adds ~10â€“17ms\n\nTotal typical delay: ~25ms. This is completely normal and barely noticeable during real driving.`
  },
  {
    keywords: ['pixel', 'wrong pin', 'wrong passkey', 'incorrect passkey', 'bluetooth pairing failed', 'pairing error'],
    answer: `"Wrong PIN" or "Incorrect passkey" on Pixel phones is a known Google bug â€” NOT an XBB issue.\n\nThe XBB Dongle works on:\nâœ… iPhone\nâœ… Other Android phones\nâŒ Some Pixel phones (Google bug â€” reported in Google's own support forum)\n\nThere is no fix from XBB's side. Try using a different phone if possible.`
  },
  {
    keywords: ['phone in car', 'phone stay', 'need phone', 'always need phone', 'phone required'],
    answer: `No, you do NOT need your phone in the car during normal use.\n\nThe phone is only needed for:\nâ€¢ Initial installation and setup\nâ€¢ Changing recipes\nâ€¢ Updating firmware or settings\n\nOnce configured, the system works fully independently â€” no phone needed.`
  },
  {
    keywords: ['dongle stay', 'remove dongle', 'always plugged', 'leave dongle', 'obd2 port', 'keep dongle'],
    answer: `Yes, the XBB Dongle MUST remain in the OBD2 port at all times.\n\nIt continuously reads the car's signals (high beam, ignition, etc.) to control the PowerUnit. If removed, the system stops.\n\nIf another device is already in your OBD2 port, use a Y-splitter cable to connect both. Note: XBB cannot guarantee compatibility with other OBD2 devices â€” must be tested.`
  },
  {
    keywords: ['error code', 'error message', 'fault code', 'warning light', 'workshop error', 'fault light'],
    answer: `Error codes after installation are usually caused by:\n\n1. Battery disconnected during installation â€” Very common. Error codes typically disappear after driving a few km. If not, use an OBD2 scanner to clear them.\n\n2. Connected directly to battery negative terminal â€” Bypasses the BMS sensor causing errors. Fix: ground to chassis instead.\n\n3. Wrong recipe selected â€” Try a different recipe and verify SYSTEM_ACTIVE turns red after locking the car.`
  },
  {
    keywords: ['lights always on', 'permanently on', 'stays on', 'never turns off', 'constantly on', 'always lit'],
    answer: `Lights always on means the cables are swapped.\n\nFix: The positive (+) cable from the battery MUST connect to PIN 2 on the XBB PowerUnit. Double-check your wiring.\n\nğŸ”— <a href="https://www.xbb.se/en/kopplingsexempel/" target="_blank">Wiring guide â†’</a>`
  },
  {
    keywords: ['lights after service', 'workshop', 'mechanic', 'service visit', 'stopped working after', 'after garage'],
    answer: `Two likely causes after a workshop visit:\n\n1. Dongle removed â€” The mechanic unplugged your XBB Dongle to read error codes and forgot to reinsert it. Simply plug it back in â€” it works again within seconds.\n\n2. Car software update â€” Workshops sometimes update car software which can affect XBB recipes. Try updating to the latest recipe in the app. If that fails, contact XBB support.\n\nğŸ”— <a href="https://www.xbb.se/en/help/" target="_blank">Contact XBB support â†’</a>`
  },
  {
    keywords: ['12v when off', '12 volt output', 'voltage output', 'measuring output', 'multimeter', 'shows voltage'],
    answer: `Measuring ~12V on the PowerUnit outputs when they're not activated is completely normal and intentional.\n\nThis allows the XBB PowerUnit to detect short circuits on the outputs. It's by design â€” not a fault.`
  },
  {
    keywords: ['smart button', 'xbb button', 'push button', 'wireless button', 'add button', 'smart button setup'],
    answer: `How to add an XBB Smart Button:\n\n1. Make sure you already have an XBB PowerUnit added in the app\n2. Go to the PowerUnit tab\n3. Tap the + button â†’ select "Add XBB Button"\n4. Follow the on-screen instructions\n5. Go to button settings to configure single/double press actions\n\nPerfect for manually toggling your LED bar on/off (e.g. in snow or summer).`
  },
  {
    keywords: ['turn off led', 'disable lights', 'snow', 'summer', 'switch off manually', 'turn off bar'],
    answer: `Two ways to manually turn off your LED bar:\n\n1. XBB Smart Button â€” Add a wireless button to toggle outputs on/off anytime.\n\n2. Remove the Dongle â€” Turn off ignition first, then unplug the XBB Dongle. System shuts off. Reinserting restores everything within seconds.`
  },
  {
    keywords: ['connect power', 'where to connect', 'fuse box', 'positive cable', 'negative cable', 'ground', 'wiring', 'how to wire'],
    answer: `How to connect the XBB PowerUnit to your car:\n\nâœ… Recommended:\nâ€¢ Positive (+) â†’ car fuse box (connected AFTER the BMS sensor)\nâ€¢ Negative (âˆ’) â†’ chassis ground point (NOT the battery negative terminal)\n\nâš ï¸ If your car has a BMS sensor, connecting directly to the battery terminal bypasses it â€” the car won't detect the extra load and the battery may drain.\n\nğŸ”— <a href="https://www.xbb.se/en/kopplingsexempel/" target="_blank">Full wiring guide â†’</a>`
  },
  {
    keywords: ['signal', 'app signal', 'highbeam signal', 'system_active', 'low_batt', 'voltage signal', 'what does signal mean', 'signal meaning'],
    answer: `Signal meanings in the XBB Configurator app:\n\nğŸŸ¢ HIGHBEAM â€” High beam is active\nğŸŸ¢ LOWBEAM â€” Low beam is active\nğŸŸ¢ REVERSELIGHT â€” Reverse light is active\nğŸŸ¢ IGNITION â€” Ignition is on\nğŸŸ¢/ğŸ”´ SYSTEM_ACTIVE â€” Green = active. Must turn RED within 2 min of locking car. If it stays green â†’ wrong recipe!\nğŸŸ¢ LOW_BATT â€” Battery too low. Charge battery or start the engine.\nğŸ“Š VOLTAGE â€” Battery voltage (e.g. "127" = 12.7V)`
  },
  {
    keywords: ['headlight type', 'what headlight', 'halogen', 'led headlight', 'xenon', 'matrix', 'adaptive'],
    answer: `Not sure what headlights your car has?\n\nâ€¢ Contact your brand's authorized workshop â€” they can look it up\nâ€¢ Visit <a href="https://www.car.info/" target="_blank">car.info</a> and search your car model\n\nNote: XBB works with LED Matrix / Auto Dimming headlights if the recipe supports adaptive high beam. Very powerful auxiliary lights may still trigger the car's auto-dimming system.`
  },
  {
    keywords: ['volvo', 'obd2 port', 'hard to insert', 'tight fit', 'wont fit', "won't fit", 'volvo port', 'volvo dongle'],
    answer: `Volvo's OBD2 port is tighter than most brands, making the XBB Dongle harder to insert.\n\nGood news: Dongles manufactured after May 1, 2022 have a better-fitting connector designed for Volvo's port.\n\nOlder Dongles are stiff but do fit and work correctly â€” just push firmly.`
  },
  {
    keywords: ['flashing', 'flickering', 'flickers', 'sometimes flashes', 'intermittent', 'random flash'],
    answer: `Lights flickering occasionally is usually a recipe issue.\n\nFix:\n1. Delete your current recipe in the app\n2. Reinstall the recipe fresh\n3. Check if a newer version of your car's recipe is available\n\nXBB constantly updates recipes â€” a newer version may have fixed this.`
  },
  {
    keywords: ['install', 'installation', 'how to install', 'setup', 'set up', 'manual', 'quick guide', 'getting started'],
    answer: `Installation resources:\n\nğŸ“– <a href="https://www.xbb.se/en/snabbguide/" target="_blank">Quick Start Manual â†’</a>\nğŸ¬ <a href="https://youtu.be/KBsbvsVQm0s" target="_blank">Installation Video â†’</a>\nğŸ”Œ <a href="https://www.xbb.se/en/kopplingsexempel/" target="_blank">Wiring Guide â†’</a>\n\nKey steps:\n1. Download XBB Configurator app\n2. Plug Dongle into OBD2 port\n3. Pair in the app and select your car's recipe\n4. Check SYSTEM_ACTIVE turns red 2 min after locking\n5. Add XBB PowerUnit in the app\n6. Wire PowerUnit to your lighting`
  },
  {
    keywords: ['support', 'contact', 'help', 'problem', 'issue', 'not working', 'broken', 'still not working'],
    answer: `Need more help? Here are your options:\n\nğŸ”§ <a href="https://www.xbb.se/en/help/" target="_blank">XBB Support Form â†’</a>\nğŸ“– <a href="https://www.xbb.se/en/snabbguide/" target="_blank">Installation Manual â†’</a>\nğŸ¬ <a href="https://www.xbb.se/en/filmer/" target="_blank">Video guides â†’</a>\nâ“ <a href="https://www.xbb.se/en/faq/" target="_blank">Full FAQ â†’</a>\nğŸª <a href="https://www.xbb.se/en/dealers/" target="_blank">Find a reseller â†’</a>`
  }
];

// â”€â”€ LIVE RECIPE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let recipeList = [];
let recipeLoaded = false;

async function loadRecipes() {
  try {
    // Try fetching via CORS proxy
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://recipelist.innowareapi.com/');
    const res = await fetch(proxyUrl);
    const json = await res.json();
    const html = json.contents;

    // Parse all text content that looks like car names
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Try table rows first
    const rows = doc.querySelectorAll('tr, li, .recipe, .car, [class*="car"], [class*="model"]');
    const items = new Set();

    rows.forEach(row => {
      const text = row.textContent.trim();
      if (text.length > 3 && text.length < 120 && !text.includes('{') && !text.includes('function')) {
        items.add(text);
      }
    });

    // Also grab all text nodes that look like car names
    const allText = doc.body ? doc.body.innerText || doc.body.textContent : '';
    const lines = allText.split('\n').map(l => l.trim()).filter(l =>
      l.length > 3 && l.length < 100 &&
      !l.includes('{') && !l.includes('function') && !l.includes('var ') &&
      !l.includes('http') && !l.startsWith('//')
    );
    lines.forEach(l => items.add(l));

    recipeList = [...items].filter(Boolean);
    recipeLoaded = recipeList.length > 5;
  } catch(e) {
    recipeLoaded = false;
  }
}

function renderCarSearch() {
  const id = 'car-search-' + Date.now();
  const resultsId = 'car-results-' + Date.now();

  setTimeout(() => {
    const input = document.getElementById(id);
    const results = document.getElementById(resultsId);
    if (!input || !results) return;

    input.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      results.innerHTML = '';
      if (!q) return;

      if (!recipeLoaded) {
        results.innerHTML = `<div class="car-no-result">âš ï¸ Car list not loaded. <a href="https://recipelist.innowareapi.com/" target="_blank">Check full list â†’</a></div>`;
        return;
      }

      const matches = recipeList.filter(r => r.toLowerCase().includes(q));
      if (matches.length === 0) {
        results.innerHTML = `<div class="car-no-result">No matches found for "<strong>${input.value}</strong>".<br>Try a different spelling or <a href="https://recipelist.innowareapi.com/" target="_blank">browse the full list â†’</a></div>`;
      } else {
        matches.slice(0, 20).forEach(m => {
          const div = document.createElement('div');
          div.className = 'car-result-item match';
          div.textContent = 'âœ… ' + m;
          results.appendChild(div);
        });
        if (matches.length > 20) {
          const more = document.createElement('div');
          more.className = 'car-result-item';
          more.innerHTML = `...and ${matches.length - 20} more. <a href="https://recipelist.innowareapi.com/" target="_blank">See full list â†’</a>`;
          results.appendChild(more);
        }
      }
    });
  }, 100);

  const loadingMsg = recipeLoaded
    ? `Type your car brand or model to search ${recipeList.length} supported recipes:`
    : `Loading car list... (or <a href="https://recipelist.innowareapi.com/" target="_blank">browse full list â†’</a>)`;

  return `The XBB Dongle works on most cars made after 2010. Search below to check if your car is supported:\n\n<div class="car-search-box"><div class="car-loading">${loadingMsg}</div><input id="${id}" type="text" placeholder="e.g. Volvo, BMW, Volkswagen..." /><div class="car-results" id="${resultsId}"></div></div>\n\nâ€¢ Cars older than 2010 are generally NOT supported.\nâ€¢ If your car isn't listed, test with the 14-day return policy.\nğŸ”— <a href="https://recipelist.innowareapi.com/" target="_blank">Browse full recipe list â†’</a>`;
}


function findAnswer(query) {
  const q = query.toLowerCase();
  let bestMatch = null;
  let bestScore = 0;

  for (const faq of FAQ) {
    let score = 0;
    for (const kw of faq.keywords) {
      if (q.includes(kw.toLowerCase())) {
        score += kw.split(' ').length;
      }
    }
    if (score > bestScore) {
      bestScore = score;
      bestMatch = faq;
    }
  }

  if (bestScore > 0) {
    if (bestMatch.answer === '__CAR_SEARCH__') return renderCarSearch();
    return bestMatch.answer;
  }

  // Also trigger car search if user mentions a car brand
  const carBrands = ['volvo','bmw','volkswagen','vw','audi','mercedes','ford','toyota','honda','hyundai','kia','seat','skoda','opel','peugeot','citroen','renault','nissan','mazda','subaru','jeep','land rover','porsche','fiat','alfa','lexus','mitsubishi','suzuki'];
  for (const brand of carBrands) {
    if (q.includes(brand)) return renderCarSearch();
  }

  return `I'm not sure about that specific question. Here are some helpful resources:\n\nğŸ”§ <a href="https://www.xbb.se/en/help/" target="_blank">XBB Support Form â†’</a>\nâ“ <a href="https://www.xbb.se/en/faq/" target="_blank">Full FAQ on xbb.se â†’</a>\nğŸ“– <a href="https://www.xbb.se/en/snabbguide/" target="_blank">Installation Manual â†’</a>\nğŸš— <a href="https://recipelist.innowareapi.com/" target="_blank">Compatible car list â†’</a>\n\nTry rephrasing â€” I cover: compatibility, battery drain, firmware updates, PowerUnit setup, Tesla/Mercedes, and more.`;
}

// â”€â”€ CHAT UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMessage(role, html) {
  const messages = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `message ${role}`;
  div.innerHTML = `
    <div class="avatar ${role}-avatar">${role === 'bot' ? 'XBB' : 'You'}</div>
    <div class="bubble">${html.replace(/\n/g, '<br>')}</div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const messages = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message bot'; div.id = 'typing';
  div.innerHTML = `<div class="avatar bot-avatar">XBB</div><div class="bubble"><div class="dots"><span></span><span></span><span></span></div></div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function ask(btn) {
  document.getElementById('userInput').value = btn.textContent;
  sendMessage();
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text) return;
  document.getElementById('suggestions').style.display = 'none';
  addMessage('user', text);
  input.value = '';
  showTyping();
  setTimeout(() => {
    removeTyping();
    addMessage('bot', findAnswer(text));
  }, 500 + Math.random() * 300);
}

window.onload = () => {
  loadRecipes(); // fetch live recipe list in background
  setTimeout(() => {
    addMessage('bot', `Hi! ğŸ‘‹ I'm the XBB System FAQ assistant. I can help you with:\n\nâ€¢ Compatible car models\nâ€¢ XBB Dongle & PowerUnit installation\nâ€¢ Troubleshooting & firmware updates\nâ€¢ Tesla, Mercedes & special setups\n\nWhat can I help you with today?`);
  }, 400);
};
</script>
</body>
</html>
